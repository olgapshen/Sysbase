> Carthago delenda est!

# Бело-сине-белая скрижаль

*Версия проекта: 3*

Здесь собраны общие полезные ссылки, команды и шаблоны для работы в экосистеме `Linux`.

Подпроекты:

- [Нибелунги](nibelungen/README.md) - `Gitlab CI Docker Runner`
- [OpenSuse](opensuse/README.md) - Особенности работы в `OpenSuse`
- [Scripts](scripts/README.md) - скрипты автоматизации
- [VimIDE](vimide/README.md) - как кодить в `vim` под `C++`

# Оглавление

- [Бело-сине-белая скрижаль](#бело-сине-белая-скрижаль)
- [Оглавление](#оглавление)
- [Философия](#философия)
  - [Святая война](#святая-война)
  - [Принцип зёрнышка](#принцип-зёрнышка)
- [Стиль кода](#стиль-кода)
- [Encode НКВД](#encode-нквд)
- [Locate](#locate)
- [Python](#python)
- [Сеть](#сеть)
- [C++](#c)
- [Cygwin](#cygwin)
- [Некоторые заметки](#некоторые-заметки)
- [Полезные ссылки](#полезные-ссылки)

# Философия

Прочитайте стандарт [POSIX][14].

## Святая война

Хочу напомнить, что у нас сейчас идёт не только война *Рохана* и *Мордора*,
но и в самом *Мордоре* идёт священная война с ещё б*О*льшим злом, чем он сам, с `Microsoft`-ом.

К сожалению в мире очень сильно `Wind`-овское лобби, но мы победим!

> Carthago delenda est!

> Життя переможе смерть, а світ – темряву

О том, как великий дьявол коррумпирует наше мироздание, можно почитать [тут][9].

## Принцип зёрнышка

Принцип следуя которому развёрстка данной экосистемы:

1. максимально формализована (приведена к модели, описана)
2. максимально автоматизирована
3. возможна, обладая лишь иформацией о структурах, без необходимости копировать бизнесс данные
4. происходит из одной точки входа, без необходимости совершать множество ручных действий

*"Принцип зёрнышка"* в ПО аналогичен тому, как из посажанного семени вырастает дерево.
Многие компании являются идеальными примерами полностью нарушающими *принцип зёрнышка*, но мы победим.

# Стиль кода

После долгих раздумия, и поддержки ~~путина~~ символа `\t` для отступов и отсутствия `\n` вконце файла,
я пересмотрела некоторые аспекты бытия и решительно отстаиваю пробелы для отступов и перенос строки в конце текстовых файлов. О его важности можно почитать [тут][10].

Поставьте галочку в опции `files.insertFinalNewline` в `VS Code`.

# Encode НКВД

Конечно, ни кто не удивится узнав, что во многих компаниях до сих пор везде используется проклятая кодировка `НКВД` со всеми прелестями голодомора и прочим коммунистическим ужасом. Этот большевистский морок нужно уничтожать не жалея сил и времени, потому что как минимум нормально существовать в наше время с кодировочными страницами `ANSI` восточноевропейских языков не представляется возможным. Посему, я всегда перевожу все проекты на `UTF-8`.

Нет способа сделать перекодировку большого количества файлов автоматом за один раз. Уничтожение большевизма, это всегда комплексный труд требующий использования нескольких ~~дивизий~~ инструментов. В нашем случае это утилита `iconv` со стороны `Linux`-а и `Notepad++` на `Wind`-е.

> При всей нашей ненависти и безпощадности к ~~врагам Рейха~~ `Wind`-е, необходимо признать, что есть несколько инструментов доступных *от туда*, аналогов которым нет *тут*; среди них: `Notepad++` и `TortoiseGit`

Мы воспользуемся общей папкой примонтированной через `/mnt/share`, как описано в [`OpenSuse`](opensuse/README.md#внешние-папки).

При отсутствии `Linux`-а, думаю вы сможете воспользоваться `Cygwin`-ом для решения данной задачи.

Сначала локализуем все файлы заражённые большевизмом:

```sh
$ cd /path/to/repo
$ file * | grep ISO
```

Скорее всего выйдут почти все `*.cpp` файлы и некоторые `*.h`.

Для того, что бы наглядно проверить кодировку, воспользуемся командой: `od -cx <file> | less`.

А вот команда для массовой перекодировки:

```sh
$ for f in $(file * | grep ISO-8859 | awk -F":" '{print $1}'); \
  do iconv -f CP1251 -t UTF-8 $f -o $f; \
  done
```

**Некоторые файлы окажутся битыми**, для решения этой проблемы открываем в `TortoiseGit` утилиту `Diff` и проходимся по каждому файлу. На тех файлах, на которых `TortoiseGit` выдаст ошибку при их открытии делаем следующее.
Открываем каждый в `Notepad++` и используем опцию `Encoding -> Convert to UTF-8`. Преимущество этого метода в том, что вы сразу видите результаты преобразования. Если даже после преобразования в `Notepadd++` файл оказывается битым, просто скопируйте туда код с исходника. Учитывая что файл уже распознаётся как `UTF-8`, текст автоматом преобразуется в нужную кодировку при копировании.

> Важно! Возможно станут перекодированы так же некоторые строки, подлежащие записи в БД, а базы данных как известно до сих пор удерживаются большевиками; если так, нужно будет точечно использовать функции перекодировки из кода `C++`, или вызвать `setenv("NLS_LANG",".UTF8", 1)` в начале программы.

# Locate

Важная утилита для поиска динамических библиотек.

Команда называется: `updatedb`. Для работы утилиты, её нужно запустить с правами `root`-а, но перед этим очень важно исключить некоторые пути поиска. В нашем случае следует исклюсить: `/var/lib/docker`.

В файле `/etc/updatedb.conf` добавьте `/var/lib/docker` в `PRUNEPATHS`.

Теперь запустите `sudo updatedb`.

# Python

`Python` имеет большое значение для превращения `Vim` в `IDE`, так как многие плагины основаны на нём.

На `OpenSuse 15.3` команда `python` запустит `python2.x`, но для дел `vim`-ных нам нужен `python3`. В `OpenSuse` нет стандартного `update-alternatives`, как на `Ubuntu`, поэтому просто измените ссылки:

```sh
$ cd /usr/bin
$ ls -la | grep python
# Только если мы имеем симлинк, тогда:
$ sudo rm python
$ sudo ln -s python3 python
```

Конечно у вас уже должен быть установлен `Python3`

---
*Небольшое отступление*.

Иногда нужно установить пакеты `Python`-а именно с `Python2`. По умолчанию `pip` в наши дни будет использовать `Python3`.

Можно было бы сделать следующее:

```sh
# Скачать нужный `get_pip.py`
$ curl -O https://bootstrap.pypa.io/pip/2.7/get-pip.py
# Установить `pip` с `Python2`
$ sudo python2 get-pip.py
```

Но, далее вы получите ошибку:

> ImportError: No module named xml.etree.ElementTree

В связи с этим проще просто портировать проект на `Python3`, [вот][12] различия синтаксиса.

---
Часто вам нужно будет узнать список установленных модулей и их версии.
Для этого используйте: `pip freeze | grep <module>`.

Центральные пакеты `Python3`-а устанавливаются по расположжению: `/usr/lib64/python3.<x>/site-packages/`, но при вызове `pip` устновка будет в `/home/<user>/.local/lib/python3.6/site-packages` по этому `pip` нужно запускать без `sudo`.

Вы всегда можете посмотреть данные по модулю с помощью: `pip show <MODULE>`.

# Сеть

В `OpenSuse` используется утилита ~~Schutzstaffel~~ `ss` заместо `netstat`.

Иногда в скриптах будет необходимо получить `PID` процесса, который слушает определённый порт:

```sh
$ PORT=8081
$ IP=0.0.0.0
$ ss -pln | grep $PORT | grep $IP  | awk '{print $7}' | awk -F"," '{print $2}' | awk -F"=" '{print $2}'
# Всё это можно записать строкой в переменную, и тогда
$ PID=$($COMMAND)
# Теперь процесс можно автоматом завершить
$ kill -9 $PID
```

# C++

Для того, что бы автоматом подставить платформонезависимый идентификатор целого числа в формате `sprintf`, исзользуйте следующий шаблон:

```c++
sprintf(buff, "%" PRId64, num);
```

Вызов `cmake` с конкретным `gcc\g++`:

```sh
#!/bin/bash

export CC=/usr/bin/gcc-9
export CXX=/usr/bin/g++-9

rm -rf CMakeFiles/ CMakeCache.txt cmake_install.cmake *_autogen
cmake .
```

# Cygwin

Вам возможно понадобится использовать `Cygwin` с `Wind`-ы для некоторых задачь, типа перекодировки страниц.

Для установка `cygwin`-а без прав админа запустите из `cmd` `Windows`-а:

```cmd
> setup-x86_64.exe --no-admin
```

Важно в рамках `Cygwin`-а установить следующие настройки, обратите внимание, что используется `--global` для задания глобальных настроек, вы можете опустить эту опцию для конфигурации только репозитория:

```sh
# Имя пользователя в рамках глобальных настроек
$ git config --global --edit
# Сохранять LF (line feed) в репозитори
$ git config core.autocrlf input
# Игнорировать права запуска файла, тк в cygwin-е это право недоступно
$ git config core.filemode false
```

# Некоторые заметки

Пример экранирования слешей в путях сохранённых в переменных при передачи переменных команде `sed`:

```sh
$ OLD_LIB=/path/to/old/lib
$ NEW_LIB=/path/to/new/lib
$ sed -i "s/${OLD_LIB//\//\\/}/${NEW_LIB//\//\\/}/" file
```
---

Размеры папок для всех случаев жизни, включая `Docker`:

```sh
#!/bin/bash
for name in `sudo ls -a $1`; do
  sudo du -sh $1/$name
done
```

# Полезные ссылки

* [SSL CRL/OSCP Habr][1]
* [SSL CRL/OSCP Англ.][2]
* [GitLab CI RegExp][3]
* [CMAKE_BUILD_TYPE (Stackoverflow)][4]
* [Архитектуры процессора][5]
* [Тесты в CMake][6]
* [Linux Локаль][7]
* [Переменные в CMake][8]
* [Комбинации клавишь Vim][11]
* [Использование помощи в Vim][13]

[1]: https://habr.com/ru/post/417521
[2]: https://jamielinux.com/docs/openssl-certificate-authority/certificate-revocation-lists.html
[3]: https://docs.gitlab.com/ee/ci/jobs/job_control.html#regular-expressions
[4]: https://stackoverflow.com/questions/48754619/what-are-cmake-build-type-debug-release-relwithdebinfo-and-minsizerel
[5]: https://habr.com/ru/post/316520
[6]: https://habr.com/ru/post/433822/
[7]: https://www.baeldung.com/linux/locale-environment-variables
[8]: https://cliutils.gitlab.io/modern-cmake/chapters/basics/variables.html
[9]: https://www.kommersant.ru/doc/2260861
[10]: https://semakin.dev/2020/05/no_newline_at_end_of_file
[11]: https://codedepth.wordpress.com/2017/08/23/vi-vim-hotkeys/
[12]: https://pythonworld.ru/osnovy/python2-vs-python3-razlichiya-sintaksisa.html
[13]: https://vimhelp.org/helphelp.txt.html#helphelp.txt
[14]: https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/contents.html
